<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Teragen crosscheck of master / HDDS-3053 / HDDS-2717 - Apache Hadoop Ozone Development notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://elek.github.io/ozone-notes/favicon.png">

  
  
  <link rel="stylesheet" href="/ozone-notes/css/style.min.e4a998fd3312b7b4b27be6b707077f6d2989860cbfb9eb31322a49baf63d68b3.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/ozone-notes/">
        <span>Home</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://elek.github.io/ozone-notes/"><img alt="Logo" src="/ozone-notes/" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://elek.github.io/ozone-notes/"><img alt="Logo" src="/ozone-notes/" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/ozone-notes/">
        <span>Home</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <nav id="TableOfContents">
  <ul>
    <li><a href="#test-method">Test method</a></li>
    <li><a href="#environment-margo-01">Environment (margo-01)</a></li>
    <li><a href="#results">Results</a>
      <ul>
        <li><a href="#running-teragen-on-master">Running teragen on master</a></li>
        <li><a href="#running-teragen-with-master--using-10-chunk-writer-thread-hdds-3053">Running teragen with master + using 10 chunk writer thread (=HDDS-3053)</a></li>
        <li><a href="#running-teragen-with-hdds-2717">Running teragen with HDDS-2717</a></li>
      </ul>
    </li>
    <li><a href="#stats">Stats</a></li>
  </ul>
</nav>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Teragen crosscheck of master / HDDS-3053 / HDDS-2717</h1>
<div class="content ">
  <h2 id="test-method">Test method</h2>
<ul>
<li>100G Teragen has been executed on Yarn with using o3fs as input / output dir</li>
<li>3 nodes are used for HDFS/Ozone 3 nodes for YARN</li>
<li>Storage
<ul>
<li>Ratis log is saved to memdisk</li>
<li>OM, SCM metadata is saved to disk (emptyDir)</li>
<li>Chunks are saved to real disk (hostPath)</li>
</ul>
</li>
<li>Default settings used except:
<ul>
<li><strong>GC</strong>
<ul>
<li>HADOOP_OPTS: -server -XX:ParallelGCThreads=8 -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseCMSInitiatingOccupancyOnly</li>
</ul>
</li>
<li><strong>Handlers</strong>:
<ul>
<li>OZONE-SITE.XML_ozone.om.handler.count.key: &ldquo;250&rdquo;</li>
<li>OZONE-SITE.XML_ozone.scm.handler.count.key: &ldquo;250&rdquo;</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Test script</strong>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">ROWS=$(numfmt --from=auto --to-unit=100 100G)
OUTPUT_DIR=teragen-$(shuf -i 1000-2000 -n 1)

#for HDFS test it was commented out
OUTPUT_DIR=o3fs://bucket1.vol1.ozone-om-0.ozone-om/$OUTPUT_DIR

MR_EXAMPLES_JAR=/opt/hadoop/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.2.1.jar

time yarn jar $MR_EXAMPLES_JAR teragen \
-Dmapreduce.map.log.level=INFO \
-Dmapreduce.reduce.log.level=INFO \
-Dyarn.app.mapreduce.am.log.level=INFO \
-Dmapreduce.map.cpu.vcores=1 \
-Dmapreduce.map.java.opts=-Xmx1536m \
-Dmapreduce.map.maxattempts=1 \
-Dmapreduce.map.memory.mb=2048 \
-Dmapreduce.map.output.compress=true \
-Dmapreduce.map.output.compress.codec=org.apache.hadoop.io.compress.Lz4Codec \
-Dmapreduce.reduce.cpu.vcores=1 \
-Dmapreduce.reduce.java.opts=-Xmx1536m \
-Dmapreduce.reduce.maxattempts=1 \
-Dmapreduce.reduce.memory.mb=2048 \
-Dyarn.app.mapreduce.am.command.opts=-Xmx768m \
-Dyarn.app.mapreduce.am.resource.mb=1024 \
-Dmapreduce.task.io.sort.factor=100 \
-Dmapreduce.task.io.sort.mb=384 \
-Dmapred.map.tasks=92 \
-Dio.file.buffer.size=131072 \
$ROWS $OUTPUT_DIR

sleep 10000000
</code></pre></div><h2 id="environment-margo-01">Environment (margo-01)</h2>
<ul>
<li>6 Dell PowerEdge R430</li>
<li>e5-2630 v4 @ 2.2Ghz</li>
<li>128GB Ram</li>
<li>4-2TB disks (xfs)</li>
</ul>
<p>Provisioned with kubernetes. 3 nodes are assigned to HDFS <em>and</em> Ozone, 3 nodes are assigned to Yarn</p>
<h2 id="results">Results</h2>
<h3 id="running-teragen-on-master">Running teragen on master</h3>
<ul>
<li>docker image: elek/ozone-dev:a68ed78d9</li>
<li>branch: master</li>
<li>date: 2020-03-04</li>
</ul>
<table>
<thead>
<tr>
<th>yarn app</th>
<th>state</th>
<th>final_status</th>
<th>elapsed_time</th>
<th>vcore_seconds</th>
</tr>
</thead>
<tbody>
<tr>
<td>application_1583403976683_0003</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>804163</td>
<td>9217</td>
</tr>
<tr>
<td>application_1583403976683_0002</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>737088</td>
<td>8411</td>
</tr>
<tr>
<td>application_1583403976683_0001</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>906759</td>
<td>6669</td>
</tr>
<tr>
<td><strong>average</strong></td>
<td></td>
<td></td>
<td><strong>816003</strong></td>
<td><strong>8099</strong></td>
</tr>
</tbody>
</table>
<h3 id="running-teragen-with-master--using-10-chunk-writer-thread-hdds-3053">Running teragen with master + using 10 chunk writer thread (=HDDS-3053)</h3>
<p>Same as before but <code>dfs.container.ratis.num.write.chunk.threads</code> set to 10</p>
<table>
<thead>
<tr>
<th>yarn app</th>
<th>state</th>
<th>final_status</th>
<th>elapsed_time</th>
<th>vcore_seconds</th>
</tr>
</thead>
<tbody>
<tr>
<td>application_1583403976683_0007</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>833224</td>
<td>9536</td>
</tr>
<tr>
<td>application_1583403976683_0006</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>892604</td>
<td>10276</td>
</tr>
<tr>
<td>application_1583403976683_0005</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>725781</td>
<td>8293</td>
</tr>
<tr>
<td>application_1583403976683_0004</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>690087</td>
<td>7897</td>
</tr>
<tr>
<td><strong>average</strong></td>
<td></td>
<td></td>
<td><strong>785424</strong></td>
<td><strong>9000</strong></td>
</tr>
</tbody>
</table>
<h3 id="running-teragen-with-hdds-2717">Running teragen with HDDS-2717</h3>
<ul>
<li>docker image: elek/ozone-dev:980b7cfb7</li>
<li>branch: elek/HDDS-2717</li>
<li>date: 2020-03-04</li>
</ul>
<table>
<thead>
<tr>
<th>yarn app</th>
<th>state</th>
<th>final_status</th>
<th>elapsed_time</th>
<th>vcore_seconds</th>
</tr>
</thead>
<tbody>
<tr>
<td>application_1583428240736_0001</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>926361</td>
<td>8333</td>
</tr>
<tr>
<td>application_1583428240736_0002</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>810906</td>
<td>9307</td>
</tr>
<tr>
<td>application_1583428240736_0005</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>956264</td>
<td>11067</td>
</tr>
<tr>
<td>application_1583428240736_0003</td>
<td>FINISHED</td>
<td>SUCCEEDED</td>
<td>812252</td>
<td>9100</td>
</tr>
<tr>
<td><strong>average</strong></td>
<td></td>
<td></td>
<td><strong>876445.75</strong></td>
<td><strong>9451</strong></td>
</tr>
</tbody>
</table>
<h2 id="stats">Stats</h2>
<p>Statistics after one (Ozone master) teragen with 100G write</p>
<table>
<thead>
<tr>
<th>metrics</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>om_metrics_num_keys</td>
<td>91</td>
</tr>
<tr>
<td>om_metrics_num_key_ops</td>
<td>1486</td>
</tr>
<tr>
<td>om_metrics_num_key_deletes</td>
<td>95</td>
</tr>
<tr>
<td>om_metrics_num_key_commits</td>
<td>93</td>
</tr>
<tr>
<td>om_metrics_num_key_lists</td>
<td>94</td>
</tr>
<tr>
<td>om_metrics_num_key_renames</td>
<td>92</td>
</tr>
<tr>
<td>om_metrics_num_block_allocations</td>
<td>373</td>
</tr>
<tr>
<td>om_metrics_num_volume_ops</td>
<td>98</td>
</tr>
<tr>
<td>om_metrics_num_fs_ops</td>
<td>1112</td>
</tr>
<tr>
<td>om_metrics_num_get_file_status</td>
<td>832</td>
</tr>
<tr>
<td>csm_metrics_write_chunk_num_ops</td>
<td>24160</td>
</tr>
<tr>
<td>storage_container_metrics_num_write_chunk</td>
<td>48320</td>
</tr>
<tr>
<td>storage_container_metrics_bytes_write_chunk</td>
<td>101006632960</td>
</tr>
<tr>
<td>ozone_manager_double_buffer_metrics_total_num_of_flush_operations</td>
<td>750</td>
</tr>
<tr>
<td>ozone_manager_double_buffer_metrics_max_number_of_transactions_flushed_in_one_iteration</td>
<td>4</td>
</tr>
<tr>
<td>rpc_rpc_processing_time_num_ops{servername=&quot;&hellip;&quot;}</td>
<td></td>
</tr>
<tr>
<td>&hellip; ScmBlockLocationProtocolService</td>
<td>469</td>
</tr>
<tr>
<td>&hellip; StorageContainerLocationProtocolService</td>
<td>1016</td>
</tr>
<tr>
<td>&hellip; StorageContainerDatanodeProtocolService</td>
<td>341</td>
</tr>
<tr>
<td>&hellip; OzoneManagerService</td>
<td>2151</td>
</tr>
</tbody>
</table>

</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/ozone-notes/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
