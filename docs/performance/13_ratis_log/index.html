<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ratis log and chunk storage separation - Hugo Whisper Theme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="www.example.com/favicon.png">

  
  
  <link rel="stylesheet" href="/www.example.com/css/style.min.db3912ad8707aa240233773715ee8b9db78ef7c625b4ec40841d61533ab76acc.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="www.example.com/">
        <span>Home</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="www.example.com"><img alt="Logo" src="/www.example.com" /></a>
    </div>
    <div class="logo-mobile">
      <a href="www.example.com"><img alt="Logo" src="/www.example.com" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="www.example.com/">
        <span>Home</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>



    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        
        <div class="col-12 col-md-9">
          
<h1 class="title">Ratis log and chunk storage separation</h1>
<div class="content ">
  <h1 id="ozone-performance-13-ratis-log-and-chunk-storage-separation">Ozone Performance #13: Ratis log and chunk storage separation</h1>
<h2 id="test-method">Test method</h2>
<ul>
<li>The same chunk writer freon test is executed: <code>ozone freon dcg -n100000000</code> with the default 1k chunk size</li>
<li>All the tests are executed on one pipeline.</li>
<li>The storage (chunk) and the metadat (ratis log) directories are modified</li>
<li>Tests were run for 15-30 mins to write significant data to be sure that the Linux write cache doesn&rsquo;t hold significant part of the data.</li>
</ul>
<h2 id="results">Results</h2>
<table>
<thead>
<tr>
<th>chunk space</th>
<th>ratis log</th>
<th>rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>memdisk</td>
<td>memdisk</td>
<td>~8900 chunk write / sec</td>
</tr>
<tr>
<td>hdd</td>
<td>same hdd</td>
<td>~420 chunk write / sec</td>
</tr>
<tr>
<td>hdd</td>
<td>different hdd</td>
<td>~520 chunk write / sec</td>
</tr>
<tr>
<td>hdd</td>
<td>memdisk</td>
<td>~1400 write / sec</td>
</tr>
</tbody>
</table>
<h3 id="hdd-storage--memdisk-ratis-log">HDD (storage) + memdisk (ratis log)</h3>
<p>The first 3 test provided steady rate:</p>
<p><img src="https://i.imgur.com/eNiUw0f.png" alt=""></p>
<p>But the 4th test was failed after a few minutes:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">2020-03-03 12:55:50 INFO  SegmentedRaftLogWorker:582 - 7a6b5796-1a27-455c-b29d-5410181262ac@group-8214B09ED1B4-SegmentedRaftLogWorker: created new log segment /data/metadata/ratis/11eb91cb-3817-48fb-8fed-8214b09ed1b4/current/log_inprogress_1125986
2020-03-03 12:55:51 INFO  SegmentedRaftLogWorker:396 - 7a6b5796-1a27-455c-b29d-5410181262ac@group-8214B09ED1B4-SegmentedRaftLogWorker: Rolling segment log-1125986_1133190 to index:1133190
2020-03-03 12:55:51 ERROR SegmentedRaftLogInputStream:122 - caught exception initializing log_1125986-1133190
java.io.FileNotFoundException: /data/metadata/ratis/11eb91cb-3817-48fb-8fed-8214b09ed1b4/current/log_1125986-1133190 (No such file or directory)
2020-03-03 12:55:51 INFO  SegmentedRaftLogWorker:540 - 7a6b5796-1a27-455c-b29d-5410181262ac@group-8214B09ED1B4-SegmentedRaftLogWorker: Rolled log segment from /data/metadata/ratis/11eb91cb-3817-48fb-8fed-8214b09ed1b4/current/log_inprogress_1125986 to /data/metadata/ratis/11eb91cb-3817-48fb-8fed-8214b09ed1b4/current/log_1125986-1133190
org.apache.ratis.server.raftlog.RaftLogIOException: java.io.FileNotFoundException: /data/metadata/ratis/11eb91cb-3817-48fb-8fed-8214b09ed1b4/current/log_1125986-1133190 (No such file or directory)
Caused by: java.io.FileNotFoundException: /data/metadata/ratis/11eb91cb-3817-48fb-8fed-8214b09ed1b4/current/log_1125986-1133190 (No such file or directory)
</code></pre></div><p><img src="https://i.imgur.com/sh9SmBi.png" alt=""></p>
<p>This is a very special case when the Ratis disk is significant faster than the storage disk. I noticed high usage of (Linux) write cache (which can be the reason of the initial peak)</p>
<h3 id="hdd-storage--memdisk-ratis-log-second-attempt">HDD (storage) + memdisk (ratis log) second attempt</h3>
<p>With the second attept, the write was more stable. The persistent speed was sg around 1.5k write / second</p>
<p><img src="https://i.imgur.com/GNwOAnu.png" alt=""></p>
<h2 id="versions">Versions</h2>
<p>Date: 2020-02-28
Docker image: elek/ozonedev:20200220-1
Ozone master: 980b7cfb7</p>
<p>Ozone version:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Source code repository git@github.com:apache/hadoop-ozone.git -r 980b7cfb7c7c62b7e4ba440326aa161d56fd8894
Compiled by elek on 2020-02-25T10:44Z
Compiled with protoc 2.5.0
From source with checksum 168b297d33a1aa1017f5f37be7141171

Using HDDS 0.5.0-SNAPSHOT
Source code repository git@github.com:apache/hadoop-ozone.git -r 980b7cfb7c7c62b7e4ba440326aa161d56fd8894
Compiled by elek on 2020-02-25T10:44Z
Compiled with protoc 2.5.0
From source with checksum 303920db6dcfc0701fd78bfff799e65
</code></pre></div><h2 id="environment">Environment</h2>
<ul>
<li>6 Dell PowerEdge R430</li>
<li>e5-2630 v4 @ 2.2Ghz</li>
<li>128GB Ram</li>
<li>4-2TB disks</li>
</ul>
<p>Provisioned with kubernetes</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">sudo sysctl -a | grep dirty
vm.dirty_background_bytes = 0
vm.dirty_background_ratio = 10
vm.dirty_bytes = 0
vm.dirty_expire_centisecs = 3000
vm.dirty_ratio = 20
vm.dirty_writeback_centisecs = 500
</code></pre></div><p>dirty_ratio is 20% which is 128GB * 0.2 = 24 Gb</p>
<p>Disk types:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">cat /sys/block/sd*/device/model
ST2000NM0018-2F3
ST2000NM0018-2F3
ST2000NM0018-2F3
ST2000NM0018-2F3
</code></pre></div><p>I didn&rsquo;t find the exact model on Seagate, but based on similar disks, the official performance could be 190-250 MByte / sec</p>
<p><a href="https://www.seagate.com/gb/en/support/internal-hard-drives/enterprise-hard-drives/3-5-hdd-10tb/">https://www.seagate.com/gb/en/support/internal-hard-drives/enterprise-hard-drives/3-5-hdd-10tb/</a></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dd if=/dev/zero of=/data/3/test count=100000 bs=10240 conv=fsync
100000+0 records in
100000+0 records out
1024000000 bytes (1.0 GB) copied, 6.22637 s, 164 MB/s
</code></pre></div>
</div>
</div>

        </div>
      </div>
    </div>
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            Based on hugo-whisper theme.
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/www.example.com/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
