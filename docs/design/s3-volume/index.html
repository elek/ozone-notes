<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>S3 Access key management for improved usability - Hugo Whisper Theme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="www.example.com/favicon.png">

  
  
  <link rel="stylesheet" href="/www.example.com/css/style.min.db3912ad8707aa240233773715ee8b9db78ef7c625b4ec40841d61533ab76acc.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="www.example.com/">
        <span>Home</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="www.example.com"><img alt="Logo" src="/www.example.com" /></a>
    </div>
    <div class="logo-mobile">
      <a href="www.example.com"><img alt="Logo" src="/www.example.com" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="www.example.com/">
        <span>Home</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>



    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        
        <div class="col-12 col-md-9">
          
<h1 class="title">S3 Access key management for improved usability</h1>
<div class="content ">
  <p>NOTE: latest version can be found in the <a href="https://github.com/apache/hadoop-ozone/blob/master/hadoop-hdds/docs/content/design/ozone-volume-management.md">Apache repository</a></p>
<h2 id="problem-statement">Problem statement</h2>
<p>Ozone has the semantics of volume <em>and</em> buckets while S3 has only buckets. To make it possible to use the same bucket both from Hadoop world and via S3 we need a mapping between then.</p>
<p>Currently we maintain a map between the S3 buckets and Ozone volumes + buckets in <code>OmMetadataManagerImpl</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">s3_bucket --&gt; ozone_volume/ozone_bucket
</code></pre></div><p>The current implementation uses the <code>&quot;s3&quot; + s3UserName</code> string as the volume name and the <code>s3BucketName</code> as the bucket name. Where <code>s3UserName</code> is is the <code>DigestUtils.md5Hex(kerberosUsername.toLowerCase())</code></p>
<p>To create an S3 bucket and use it from o3fs, you should:</p>
<ol>
<li>Get your personal secret based on your kerberos keytab</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt; kinit -kt /etc/security/keytabs/testuser.keytab testuser/scm
&gt; ozone s3 getsecret
awsAccessKey=testuser/scm@EXAMPLE.COM
awsSecret=7a6d81dbae019085585513757b1e5332289bdbffa849126bcb7c20f2d9852092
</code></pre></div><ol start="2">
<li>Create the bucket with S3 cli</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt; export AWS_ACCESS_KEY_ID=testuser/scm@EXAMPLE.COM
&gt; export AWS_SECRET_ACCESS_KEY=7a6d81dbae019085585513757b1e5332289bdbffa849126bcb7c20f2d9852092
&gt; aws s3api --endpoint http://localhost:9878 create-bucket --bucket=bucket1
</code></pre></div><ol start="3">
<li>And identify the ozone path</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt; ozone s3 path bucket1
Volume name for S3Bucket is : s3c89e813c80ffcea9543004d57b2a1239
Ozone FileSystem Uri is : o3fs://bucket1.s3c89e813c80ffcea9543004d57b2a1239
</code></pre></div><h2 id="the-problems">The problems</h2>
<ol>
<li>This mapping is very confusing. Based on external feedback it&rsquo;s hard to understand what is the exact Ozone URL which should be used</li>
<li>It&rsquo;s almost impossible to remember to the volume name</li>
<li>We don&rsquo;t support the revocatin of access keys</li>
</ol>
<h2 id="possible-solutions">Possible solutions</h2>
<h3 id="1-predefined-volume-mapping">1. Predefined volume mapping</h3>
<ol>
<li>Let&rsquo;s support multiple <code>ACCESS_KEY_ID</code> for the same user.</li>
<li>For each <code>ACCESS_KEY_ID</code> a volume name MUST be defined.</li>
<li>Instead of using a specific mapping table, the <code>ACCESS_KEY_ID</code> would provide a <strong>view</strong> of the buckets in the specified volume.</li>
</ol>
<p>With this approach the used volume will be more visible and &ndash; hopefully &ndash; understandable.</p>
<p>Instead of using <code>ozone s3 getsecret</code>, following commands would be used:</p>
<ol>
<li><code>ozone s3 secret create --volume=myvolume</code>: To create a secret and use myvolume for all of these buckets</li>
<li><code>ozone s3 secret list</code>: To list all of the existing S3 secrets (available for the current user)</li>
<li><code>ozone s3 secret delete &lt;ACCESS_KEY_ID</code>: To delete any secret</li>
</ol>
<p>The <code>AWS_ACCESS_KEY_ID</code> should be a random identifier instead of using a kerberos principal.</p>
<ul>
<li><strong>pro</strong>: Easier to understand</li>
<li><strong>con</strong>: We should either have global unique bucket names or it will be possible to see two different buckets with</li>
</ul>
<h3 id="2-using-one-volume">2. Using one volume</h3>
<p>Let&rsquo;s always use <code>s3</code> volume for all the s3 buckets (or any other predefined version.)</p>
<ul>
<li><strong>pro</strong>: Dead simple</li>
<li><strong>con</strong>: Volume is removed from the s3 bucket part (and in this case, why do you need volume at all?).</li>
</ul>
<h3 id="3-string-magic">3. String magic</h3>
<p>We can try to make volume name visible for the S3 world to use some structured bucket names. Unforunatelly the available separated charates are very limited:</p>
<p>For example we can&rsquo;t use <code>/</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">aws s3api create-bucket --bucket=vol1/bucket1

Parameter validation failed:
Invalid bucket name &#34;vol1/bucket1&#34;: Bucket name must match the regex &#34;^[a-zA-Z0-9.\-_]{1,255}$&#34; or be an ARN matching the regex &#34;^arn:(aws).*:s3:[a-z\-0-9]+:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-]{1,63}$&#34;
</code></pre></div><p>But it&rsquo;s possible to use <code>volume-bucket</code> notion:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">aws s3api create-bucket --bucket=vol1-bucket1
</code></pre></div><ul>
<li><strong>pro</strong>: Volume mapping is visible all the time.</li>
<li><strong>con</strong>: Harder to use any external tool with defaults (all the buckets should have at least one <code>-</code>)</li>
</ul>
<h3 id="4-remove-volume-from-the-ozone-path">4. Remove volume <strong>from the ozone path</strong></h3>
<p>We can also make <code>volume</code>-s as a lightweight <em>bucket group</em> object with removing it from the ozonefs path. With this approach we can use all the benefits of the volumes as an administration object but it would be removed from the <code>o3fs</code> path.</p>
<ul>
<li><strong>pro</strong>: can be the most simple solution. Easy to understand as there are no more volumes in the path.</li>
<li><strong>con</strong>: Bigger change (all the API can&rsquo;t be modified to make volumes optional)</li>
<li><strong>pro</strong>: Harder to dis-join namespaces based on volumes. (With the current scheme, it&rsquo;s easier to delegate the responsibilties for one volumes to a different OM)</li>
</ul>

</div>
</div>

        </div>
      </div>
    </div>
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            Based on hugo-whisper theme.
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/www.example.com/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
